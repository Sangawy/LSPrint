<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبۆردی کەسانەکان | Persons Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header-section {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .search-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .alert-custom {
            border-radius: 10px;
            border: none;
        }
        
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Header Section -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 mb-0">
                        <i class="bi bi-people-fill me-3"></i>
                        داشبۆردی کەسانەکان
                    </h1>
                    <p class="mb-0 mt-2">Persons Management Dashboard</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="refreshBtn" class="btn btn-light btn-custom me-2">
                        <i class="bi bi-arrow-clockwise"></i> نوێکردنەوە
                    </button>
                    <button id="exportBtn" class="btn btn-warning btn-custom">
                        <i class="bi bi-file-earmark-pdf"></i> PDF ڕاپۆرت
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- Navigation Tabs -->
        <div class="search-section">
            <ul class="nav nav-pills justify-content-center mb-4">
                <li class="nav-item">
                    <a class="nav-link active" href="/">
                        <i class="bi bi-people me-2"></i>کەسانەکان | Persons
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/views/waredat2023.html">
                        <i class="bi bi-box-seam me-2"></i>کاڵاکان | Warehouse 2023
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="search-section">
            <h5 class="mb-3">
                <i class="bi bi-search me-2"></i>
                گەڕان و فیلتەرکردن | Search & Filter
            </h5>
            
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="searchNaw" class="form-label">گەڕان بە ناو | Search by Name</label>
                    <input type="text" class="form-control" id="searchNaw" placeholder="ناو...">
                </div>
                <div class="col-md-3">
                    <label for="searchLogo" class="form-label">گەڕان بە لۆگۆ | Search by Logo</label>
                    <input type="text" class="form-control" id="searchLogo" placeholder="لۆگۆ...">
                </div>
                <div class="col-md-3">
                    <label for="searchMobil" class="form-label">گەڕان بە مۆبایل | Search by Mobile</label>
                    <input type="text" class="form-control" id="searchMobil" placeholder="ژمارەی مۆبایل...">
                </div>
                <div class="col-md-3">
                    <label for="searchEmail" class="form-label">گەڕان بە ئیمەیڵ | Search by Email</label>
                    <input type="text" class="form-control" id="searchEmail" placeholder="ئیمەیڵ...">
                </div>
            </div>
            
            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <label for="searchCountry" class="form-label">گەڕان بە وڵات | Search by Country</label>
                    <input type="text" class="form-control" id="searchCountry" placeholder="وڵات...">
                </div>
                <div class="col-md-4">
                    <label for="searchAddress" class="form-label">گەڕان بە ناونیشان | Search by Address</label>
                    <input type="text" class="form-control" id="searchAddress" placeholder="ناونیشان...">
                </div>
                <div class="col-md-4">
                    <label for="searchNameEn" class="form-label">گەڕان بە ناوی ئینگلیزی | English Name</label>
                    <input type="text" class="form-control" id="searchNameEn" placeholder="English name...">
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <button id="searchBtn" class="btn btn-primary btn-custom me-2">
                        <i class="bi bi-search"></i> گەڕان
                    </button>
                    <button id="clearBtn" class="btn btn-outline-secondary btn-custom">
                        <i class="bi bi-x-circle"></i> پاککردنەوە
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-0" id="totalCount">0</h4>
                        <p class="text-muted mb-0">کۆی گشتی | Total Records</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-funnel text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-0" id="filteredCount">0</h4>
                        <p class="text-muted mb-0">ئەنجامی فیلتەر | Filtered Results</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-clock text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-0" id="lastUpdate">--:--</h4>
                        <p class="text-muted mb-0">نوێکردنەوەی دوایین | Last Update</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">بارکردنی داتا... | Loading data...</p>
        </div>

        <!-- Error Alert -->
        <div class="alert alert-danger alert-custom d-none" id="errorAlert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
        </div>

        <!-- Success Alert -->
        <div class="alert alert-success alert-custom d-none" id="successAlert">
            <i class="bi bi-check-circle me-2"></i>
            <span id="successMessage"></span>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>
                    لیستی کەسانەکان | Persons List
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <small class="text-muted" id="recordInfo">0 ڕیز نیشان دراوە</small>
                    <select class="form-select form-select-sm" id="recordsPerPage" style="width: auto;">
                        <option value="10">10 ڕیز</option>
                        <option value="25" selected>25 ڕیز</option>
                        <option value="50">50 ڕیز</option>
                        <option value="100">100 ڕیز</option>
                    </select>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="personsTable">
                    <thead>
                        <tr id="tableHeader">
                            <!-- Headers will be populated dynamically -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="pagination-info">
                    <span id="paginationInfo" class="text-muted">لاپەڕە 1 لە 1</span>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0" id="paginationControls">
                        <!-- Pagination buttons will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentData = [];
        let currentPagination = {};
        let currentPage = 1;
        let recordsPerPage = 25;
        let isSearchMode = false;

        // DOM elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const tableBody = document.getElementById('tableBody');
        const tableHeader = document.getElementById('tableHeader');
        const totalCountEl = document.getElementById('totalCount');
        const filteredCountEl = document.getElementById('filteredCount');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const recordInfoEl = document.getElementById('recordInfo');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationControls = document.getElementById('paginationControls');
        const recordsPerPageSelect = document.getElementById('recordsPerPage');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadPersonsData();
            setupEventListeners();
        });

        // Event listeners
        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', () => loadPersonsData(1));
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('clearBtn').addEventListener('click', clearSearch);
            document.getElementById('exportBtn').addEventListener('click', exportToPDF);
            recordsPerPageSelect.addEventListener('change', handleRecordsPerPageChange);
            
            // Real-time search on input
            document.getElementById('searchNaw').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('searchLogo').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('searchMobil').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('searchEmail').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('searchCountry').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('searchAddress').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('searchNameEn').addEventListener('input', debounce(performSearch, 500));
        }

        // Debounce function for real-time search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load persons data from API with pagination
        async function loadPersonsData(page = 1) {
            currentPage = page;
            isSearchMode = false;
            showLoading(true);
            hideAlerts();
            
            try {
                const response = await fetch(`/api/persons?page=${page}&limit=${recordsPerPage}`);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    currentPagination = result.pagination;
                    populateTable(currentData);
                    updatePagination();
                    updateStatistics();
                    showSuccess('داتاکان بە سەرکەوتووی بارکران | Data loaded successfully');
                } else {
                    showError('هەڵەی بارکردنی داتا | Error loading data: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('هەڵەی پەیوەندی بە سێرڤەر | Server connection error');
            } finally {
                showLoading(false);
            }
        }

        // Perform search and filtering with pagination
        async function performSearch(page = 1) {
            const naw = document.getElementById('searchNaw').value.trim();
            const logo = document.getElementById('searchLogo').value.trim();
            const mobil = document.getElementById('searchMobil').value.trim();
            const email = document.getElementById('searchEmail').value.trim();
            const country = document.getElementById('searchCountry').value.trim();
            const address = document.getElementById('searchAddress').value.trim();
            const name_en = document.getElementById('searchNameEn').value.trim();
            
            // Check if any search field has value
            const hasSearchTerms = naw || logo || mobil || email || country || address || name_en;
            
            // If no search terms, load normal data
            if (!hasSearchTerms) {
                loadPersonsData(page);
                return;
            }
            
            currentPage = page;
            isSearchMode = true;
            showLoading(true);
            
            try {
                const params = new URLSearchParams();
                if (naw) params.append('naw', naw);
                if (logo) params.append('logo', logo);
                if (mobil) params.append('mobil', mobil);
                if (email) params.append('email', email);
                if (country) params.append('country', country);
                if (address) params.append('address', address);
                if (name_en) params.append('name_en', name_en);
                params.append('page', page);
                params.append('limit', recordsPerPage);
                
                const response = await fetch(`/api/persons/search?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    currentPagination = result.pagination;
                    populateTable(currentData);
                    updatePagination();
                    updateStatistics();
                    
                    if (currentData.length === 0) {
                        showError('هیچ ئەنجامێک نەدۆزرایەوە | No results found');
                    }
                } else {
                    showError('هەڵەی گەڕان | Search error: ' + result.error);
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('هەڵەی گەڕان | Search error');
            } finally {
                showLoading(false);
            }
        }

        // Clear search filters
        function clearSearch() {
            document.getElementById('searchNaw').value = '';
            document.getElementById('searchLogo').value = '';
            document.getElementById('searchMobil').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('searchCountry').value = '';
            document.getElementById('searchAddress').value = '';
            document.getElementById('searchNameEn').value = '';
            
            loadPersonsData(1);
            hideAlerts();
        }

        // Populate table with data
        function populateTable(data) {
            // Clear existing content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="100%" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0">هیچ داتایەک نیە | No data available</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Create table headers
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });
            
            // Create table rows
            data.forEach((person, index) => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = person[header] || '';
                    row.appendChild(td);
                });
                tableBody.appendChild(row);
            });
            
            // Update record info
            const totalRecords = currentPagination.totalRecords || data.length;
            recordInfoEl.textContent = `${data.length} ڕیز نیشان دراوە لە ${totalRecords} | ${data.length} of ${totalRecords} records shown`;
        }

        // Update statistics
        function updateStatistics() {
            if (currentPagination.totalRecords !== undefined) {
                totalCountEl.textContent = currentPagination.totalRecords;
                filteredCountEl.textContent = currentData.length;
            }
            lastUpdateEl.textContent = new Date().toLocaleTimeString();
        }
        
        // Update pagination controls
        function updatePagination() {
            if (!currentPagination) return;
            
            const { currentPage: page, totalPages, totalRecords, recordsPerPage: perPage } = currentPagination;
            
            // Update pagination info
            const startRecord = ((page - 1) * perPage) + 1;
            const endRecord = Math.min(page * perPage, totalRecords);
            paginationInfo.textContent = `لاپەڕە ${page} لە ${totalPages} (${startRecord}-${endRecord} لە ${totalRecords})`;
            
            // Generate pagination buttons
            let paginationHTML = '';
            
            // Previous button
            if (currentPagination.hasPreviousPage) {
                paginationHTML += `<li class="page-item"><button class="page-link" onclick="changePage(${page - 1})">پێشوو</button></li>`;
            } else {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">پێشوو</span></li>`;
            }
            
            // Page numbers
            let startPage = Math.max(1, page - 2);
            let endPage = Math.min(totalPages, page + 2);
            
            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><button class="page-link" onclick="changePage(1)">1</button></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === page ? 'active' : '';
                paginationHTML += `<li class="page-item ${activeClass}"><button class="page-link" onclick="changePage(${i})">${i}</button></li>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><button class="page-link" onclick="changePage(${totalPages})">${totalPages}</button></li>`;
            }
            
            // Next button
            if (currentPagination.hasNextPage) {
                paginationHTML += `<li class="page-item"><button class="page-link" onclick="changePage(${page + 1})">دواتر</button></li>`;
            } else {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">دواتر</span></li>`;
            }
            
            paginationControls.innerHTML = paginationHTML;
        }
        
        // Change page function
        function changePage(page) {
            if (isSearchMode) {
                performSearch(page);
            } else {
                loadPersonsData(page);
            }
        }
        
        // Handle records per page change
        function handleRecordsPerPageChange() {
            recordsPerPage = parseInt(recordsPerPageSelect.value);
            if (isSearchMode) {
                performSearch(1);
            } else {
                loadPersonsData(1);
            }
        }

        // Export to PDF
        async function exportToPDF() {
            if (currentData.length === 0) {
                showError('هیچ داتایەک نیە بۆ هەناردەکردن | No data to export');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: currentData })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `persons-report-page-${currentPage}-${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showSuccess('ڕاپۆرت بە سەرکەوتووی دروست کرا | Report generated successfully');
                } else {
                    showError('هەڵەی دروستکردنی ڕاپۆرت | Error generating report');
                }
            } catch (error) {
                console.error('PDF export error:', error);
                showError('هەڵەی دروستکردنی PDF | PDF generation error');
            } finally {
                showLoading(false);
            }
        }

        // Utility functions
        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorAlert.classList.remove('d-none');
            setTimeout(() => errorAlert.classList.add('d-none'), 5000);
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            successAlert.classList.remove('d-none');
            setTimeout(() => successAlert.classList.add('d-none'), 3000);
        }

        function hideAlerts() {
            errorAlert.classList.add('d-none');
            successAlert.classList.add('d-none');
        }
    </script>

</body>
</html>